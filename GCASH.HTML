<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GCASH Cash Out — 32-char fixed receipt (restored UI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { margin:0; padding:18px; background:#f4f4f4; font-family: Arial, Helvetica, sans-serif; }
    .container { max-width:760px; margin:0 auto; background:#fff; padding:16px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    h1 { margin:0 0 8px; font-size:1.2rem; text-align:center; }
    .subtitle { text-align:center; color:#666; margin-bottom:12px; font-size:0.9rem; }
    label { display:block; font-weight:600; margin-top:10px; margin-bottom:6px; }
    input[type="text"], textarea { width:100%; padding:10px; font-size:1rem; border:1px solid #ccc; border-radius:6px; outline:none; }
    textarea { min-height:180px; font-family:"Courier New", monospace; white-space: pre; }
    .inline-row { display:flex; gap:8px; align-items:center; }
    .btn { padding:8px 12px; border-radius:6px; color:#fff; border:none; cursor:pointer; font-size:0.9rem; }
    .btn-blue { background:#007bff } .btn-gray { background:#6c757d } .btn-red { background:#dc3545 }
    .btn-wide { width:100% } .btn-small { font-size:0.82rem; padding:6px 10px; }
    .note { font-size:0.85rem; color:#666; margin-top:6px; }
    .receipt-preview { font-family:"Courier New", monospace; font-size:13px; line-height:1.15; white-space: pre; background:#fff; padding:10px; border-radius:6px; border:1px solid #ddd; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>GCASH - CASH OUT</h1>
    <div class="subtitle">32-char thermal receipt (58mm) • All lines exactly 32 chars</div>

    <label>Reference Number</label>
    <div class="inline-row">
      <input type="text" id="refNo" inputmode="text" placeholder="Enter or paste Ref No.">
      <button id="pasteRefBtn" class="btn btn-blue btn-small">Paste</button>
    </div>

    <label>Amount (GCash Sent)</label>
    <input type="text" id="amount" inputmode="decimal" placeholder="e.g. 1500">

    <label>Service Fee</label>
    <div class="inline-row">
      <input type="text" id="serviceFee" inputmode="decimal" placeholder="Auto-calculated (editable)">
      <label style="font-size:0.9rem;"><input type="checkbox" id="feeIncluded"> Fee included in amount</label>
    </div>
    <div class="note">If checked → customer already paid the fee. If unchecked → fee deducted from received cash.</div>

    <label>Total (Cash Received)</label>
    <input type="text" id="total" readonly>

    <label>Date</label>
    <input type="text" id="dateField" readonly>

    <label>Time</label>
    <div class="inline-row">
      <input type="text" id="timeField" placeholder="03:45 PM">
      <button id="timeNowBtn" class="btn btn-gray btn-small">Now</button>
    </div>

    <div style="margin-top:12px;">
      <button id="generateBtn" class="btn btn-blue btn-wide">Generate Receipt</button>
    </div>
    <div style="margin-top:8px;">
      <button id="clearBtn" class="btn btn-red btn-wide">Clear</button>
    </div>

    <label style="margin-top:12px;">Receipt (copy to thermal app)</label>
    <textarea id="receiptText" readonly></textarea>
    <button id="copyReceiptBtn" class="btn btn-blue btn-wide" style="margin-top:8px;">Copy Receipt</button>

    <div style="margin-top:12px;">
      <div class="note">Preview (| markers show line start/end — each line is exactly 32 chars):</div>
      <div id="preview" class="receipt-preview"></div>
    </div>
  </div>

<script>
/* ========== Configuration ========== */
const LINE_WIDTH = 32;       // total characters per line
const RIGHT_COL_WIDTH = 13;  // reserved width for money column (adjusted after testing)

/* ========== Helpers ========== */
function parseMoney(s){
  if(!s) return 0;
  const cleaned = String(s).replace(/[^0-9.\-]/g, "");
  const n = parseFloat(cleaned);
  return isNaN(n) ? 0 : n;
}
function formatMoney(n){
  if(isNaN(n)) n = 0;
  const parts = Number(n).toFixed(2).split('.');
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  return parts.join('.');
}
// pad left (for right-aligned column)
function padLeft(txt, width){
  txt = String(txt);
  if(txt.length >= width) return txt.slice(-width);
  return " ".repeat(width - txt.length) + txt;
}
function padRight(txt, width){
  txt = String(txt);
  if(txt.length >= width) return txt.slice(0, width);
  return txt + " ".repeat(width - txt.length);
}
// keep rightmost characters when truncating (so decimals preserved)
function rightTruncateKeepEnd(txt, width){
  txt = String(txt);
  if(txt.length <= width) return txt;
  return txt.slice(txt.length - width);
}
// ensure exact LINE_WIDTH
function fixLineLength(line){
  if(line.length === LINE_WIDTH) return line;
  if(line.length < LINE_WIDTH) return line + " ".repeat(LINE_WIDTH - line.length);
  return line.slice(0, LINE_WIDTH);
}

/* ========== Service fee logic (keeps original behavior) ========== */
function computeServiceFee(amount){
  if(!amount || amount <= 0) return 0;
  let feeRaw = amount * 0.02;
  feeRaw = Math.floor(feeRaw);
  let prev5 = Math.floor(feeRaw / 5) * 5;
  if(prev5 < 5) prev5 = 5;
  return prev5;
}

/* ========== Receipt builders ========== */
// Build a line where the right column occupies RIGHT_COL_WIDTH and the total line width is LINE_WIDTH
function receiptLine(left, right){
  left = left == null ? "" : String(left);
  right = right == null ? "" : String(right);

  // prepare right column (keep rightmost characters, then left-pad to RIGHT_COL_WIDTH)
  const rightRaw = rightTruncateKeepEnd(right, RIGHT_COL_WIDTH);
  const rightCol = padLeft(rightRaw, RIGHT_COL_WIDTH);

  // left max length = LINE_WIDTH - RIGHT_COL_WIDTH - at least 1 space
  const maxLeft = Math.max(0, LINE_WIDTH - RIGHT_COL_WIDTH - 1);
  const leftSafe = left.length > maxLeft ? left.slice(0, maxLeft - 1) + "…" : left;

  // spaces to fill the rest
  const spacesNeeded = LINE_WIDTH - leftSafe.length - rightCol.length;
  const between = spacesNeeded > 0 ? " ".repeat(spacesNeeded) : "";

  return fixLineLength(leftSafe + between + rightCol);
}

function centerLine(txt){
  txt = txt == null ? "" : String(txt);
  if(txt.length >= LINE_WIDTH) return fixLineLength(txt);
  const pad = Math.floor((LINE_WIDTH - txt.length) / 2);
  return fixLineLength(" ".repeat(pad) + txt + " ".repeat(LINE_WIDTH - pad - txt.length));
}
function dashLine(){ return "-".repeat(LINE_WIDTH); }
function underlineAfterLabel(label){
  label = label == null ? "" : String(label);
  const maxLabel = LINE_WIDTH - 1;
  const labelSafe = label.length > maxLabel ? label.slice(0, maxLabel - 1) + "…" : label;
  const remain = LINE_WIDTH - labelSafe.length - 1;
  const underline = remain > 0 ? "_".repeat(remain) : "";
  return fixLineLength(labelSafe + " " + underline);
}

/* ========== Generate receipt text (strict 32-char lines) ========== */
function generateReceiptText(){
  const refNo = document.getElementById("refNo").value.trim() || "-";
  const amountBase = parseMoney(document.getElementById("amount").value);
  const manualFee = parseMoney(document.getElementById("serviceFee").value);
  const feeIncluded = document.getElementById("feeIncluded").checked;

  const computedFee = computeServiceFee(amountBase);
  const fee = manualFee > 0 ? manualFee : computedFee;

  // follow previous behavior: when feeIncluded is true, displayAmount = amountBase + fee; displayTotal = amountBase
  let displayAmount, displayTotal;
  if(feeIncluded){
    displayAmount = amountBase + fee;
    displayTotal = amountBase;
  } else {
    displayAmount = amountBase;
    displayTotal = amountBase - fee;
  }

  const amtStr = "P " + formatMoney(displayAmount);
  const feeStr = "P " + formatMoney(fee);
  const totStr = "P " + formatMoney(displayTotal);

  const now = new Date();
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const dateStr = months[now.getMonth()] + " " + now.getDate() + ", " + now.getFullYear();
  const timeStr = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});

  const lines = [];
  lines.push(centerLine("GCASH - CASH OUT"));
  lines.push(fixLineLength("")); // blank
  lines.push(receiptLine("Date:", dateStr));  // date on its own line
  lines.push(receiptLine("Time:", timeStr));  // time on its own line
  lines.push(dashLine());
  lines.push(receiptLine("Ref No.:", refNo));
  lines.push(dashLine());
  lines.push(receiptLine("Amount:", amtStr));
  lines.push(receiptLine("Service Fee:", feeStr));
  lines.push(receiptLine("TOTAL:", totStr));
  lines.push(dashLine());
  lines.push(fixLineLength("")); // blank
  lines.push(fixLineLength("Received by:")); // plain label
  lines.push(underlineAfterLabel("Name:"));
  lines.push(underlineAfterLabel("Signature:"));

  // Ensure every line is exactly LINE_WIDTH and join
  return lines.map(fixLineLength).join("\n");
}

/* ========== UI helpers ========== */
function renderPreviewAndTextarea(txt){
  const preview = txt.split("\n").map(l => "|" + l + "|").join("\n");
  document.getElementById("preview").textContent = preview;
  document.getElementById("receiptText").value = txt;
}

function copyReceipt(){
  const txt = document.getElementById("receiptText").value;
  if(!txt.trim()){ alert("No receipt to copy."); return; }
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(()=> alert("Receipt copied!"));
  } else {
    const ta = document.getElementById("receiptText");
    ta.select(); document.execCommand("copy"); alert("Receipt copied (fallback).");
  }
}

function updateFromAmount(){
  const amount = parseMoney(document.getElementById("amount").value);
  const included = document.getElementById("feeIncluded").checked;
  if(amount <= 0){
    document.getElementById("serviceFee").value = "";
    document.getElementById("total").value = "";
    renderPreviewAndTextarea((" ".repeat(LINE_WIDTH) + "\n").repeat(12));
    return;
  }
  const fee = computeServiceFee(amount);
  document.getElementById("serviceFee").value = formatMoney(fee);
  if(included) document.getElementById("total").value = formatMoney(amount);
  else document.getElementById("total").value = formatMoney(amount - fee);
}

function updateTotalFromManualFee(){
  const amount = parseMoney(document.getElementById("amount").value);
  const fee = parseMoney(document.getElementById("serviceFee").value);
  const included = document.getElementById("feeIncluded").checked;
  if(included) document.getElementById("total").value = formatMoney(amount);
  else document.getElementById("total").value = formatMoney(amount - fee);
}

function initDefaults(){
  const now = new Date();
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  document.getElementById("dateField").value = months[now.getMonth()] + " " + now.getDate() + ", " + now.getFullYear();
  document.getElementById("timeField").value = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
}

/* ========== Event bindings ========== */
window.addEventListener("DOMContentLoaded", () => {
  initDefaults();
  renderPreviewAndTextarea((" ".repeat(LINE_WIDTH) + "\n").repeat(12));

  document.getElementById("amount").addEventListener("input", updateFromAmount);
  document.getElementById("serviceFee").addEventListener("input", updateTotalFromManualFee);
  document.getElementById("feeIncluded").addEventListener("change", updateFromAmount);

  document.getElementById("timeNowBtn").addEventListener("click", () => {
    const now = new Date();
    document.getElementById("timeField").value = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
  });

  document.getElementById("generateBtn").addEventListener("click", () => {
    const txt = generateReceiptText();
    renderPreviewAndTextarea(txt);
  });

  document.getElementById("copyReceiptBtn").addEventListener("click", copyReceipt);

  document.getElementById("clearBtn").addEventListener("click", () => {
    document.getElementById("refNo").value = "";
    document.getElementById("amount").value = "";
    document.getElementById("serviceFee").value = "";
    document.getElementById("total").value = "";
    document.getElementById("feeIncluded").checked = false;
    initDefaults();
    renderPreviewAndTextarea((" ".repeat(LINE_WIDTH) + "\n").repeat(12));
  });

  document.getElementById("pasteRefBtn").addEventListener("click", () => {
    const input = document.getElementById("refNo");
    if(navigator.clipboard && navigator.clipboard.readText){
      navigator.clipboard.readText().then(t => input.value = t || "").catch(() => {
        input.focus();
        alert("Unable to read clipboard. On iPhone long-press then Paste.");
      });
    } else {
      input.focus();
      alert("Unable to read clipboard. On iPhone long-press then Paste.");
    }
  });
});
</script>
</body>
</html>
