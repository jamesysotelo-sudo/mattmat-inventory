<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mattmat’s Inventory — Simple v3.1.1 (Fixed Build)</title>
<style>
  /* Minimalist light theme */
  :root{
    --bg:#f2f4f7;
    --card:#ffffff;
    --muted:#6b7280;
    --border:#d1d5db;
    --accent:#111827;
    --success:#16a34a;
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:var(--bg); color:var(--accent); -webkit-font-smoothing:antialiased;}
  .app{max-width:1100px;margin:20px auto;padding:18px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
  header h1{font-size:18px;margin:0;}
  .subtitle{font-size:12px;color:var(--muted);}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  button, .btn{background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;}
  .btn.primary{background:linear-gradient(#111827,#111827);color:#fff;border:0;}
  .panel{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;}
  .layout{display:grid;grid-template-columns:1fr 320px;gap:12px;}
  @media(max-width:900px){ .layout{grid-template-columns:1fr;}}
  .search-row{display:flex;gap:8px;margin-bottom:10px;align-items:center;}
  input[type="search"], input[type="text"], input[type="number"], select, textarea{
    padding:8px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:transparent;
  }
  table{width:100%;border-collapse:collapse;font-size:13px;}
  th, td{padding:8px;border-bottom:1px solid #eee;text-align:left;}
  th{cursor:pointer;user-select:none;background:transparent;position:relative;}
  th .sort-ind{font-size:11px;color:var(--muted);margin-left:6px;}
  .row-actions{display:flex;gap:6px;align-items:center;}
  .small{font-size:12px;padding:6px 8px;border-radius:6px;}
  .muted{color:var(--muted);}
  .category-pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#fff;}
  .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,0.45);display:flex;align-items:center;justify-content:center;z-index:30;}
  .modal{width:520px;max-width:96%;background:var(--card);border-radius:10px;padding:14px;border:1px solid var(--border);box-shadow:0 8px 24px rgba(15,23,42,0.08);}
  .modal h3{margin:0 0 8px 0;}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .form-row{display:flex;flex-direction:column;gap:6px;margin-bottom:8px;}
  .flex{display:flex;gap:8px;align-items:center;}
  .right{margin-left:auto;}
  .purchase-list{display:flex;flex-direction:column;gap:8px;}
  .purchase-item{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:6px;border:1px dashed var(--border);border-radius:8px;}
  .hide-print{display:block;}
  @media print{
    body{background:white;}
    .hide-print{display:none !important;}
    .panel{box-shadow:none;border:0;}
    header{display:none;}
  }
  footer{font-size:12px;color:var(--muted);margin-top:12px;text-align:center;}
  /* small helpers */
  .overflow-x{overflow:auto;}
  .note{font-size:12px;color:var(--muted);}
  .danger{color:#b91c1c;}
  .success{color:var(--success);}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Mattmat’s Inventory — Simple v3.1.1 (Fixed Build)</h1>
        <div class="subtitle">Single-file offline inventory — localStorage + optional Drive import/export</div>
      </div>
      <div class="controls hide-print">
        <button id="btnAdd" class="btn">+ Add Item</button>
        <button id="btnImport" class="btn">Import CSV</button>
        <button id="btnExport" class="btn">Export CSV</button>
        <button id="btnDriveImport" class="btn">Drive Import</button>
        <button id="btnDriveExport" class="btn">Drive Export</button>
        <button id="btnCategories" class="btn">Categories</button>
      </div>
    </header>

    <div class="layout">
      <main>
        <div class="panel">
          <div class="search-row">
            <input id="search" type="search" placeholder="Search products, barcode, notes..." style="flex:1" />
            <select id="filterCategory">
              <option value="">All categories</option>
            </select>
            <select id="rowsPerPage">
              <option>25</option><option>50</option><option>100</option>
            </select>
          </div>

          <div class="overflow-x">
            <table id="productTable" aria-label="Products">
              <thead>
                <tr>
                  <th data-key="barcode">Barcode <span class="sort-ind"></span></th>
                  <th data-key="name">Product Name <span class="sort-ind"></span></th>
                  <th data-key="category">Category <span class="sort-ind"></span></th>
                  <th data-key="stocks">Stocks <span class="sort-ind"></span></th>
                  <th data-key="sell">Sell/pc <span class="sort-ind"></span></th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productBody">
                <!-- rows injected -->
              </tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:12px" class="panel hide-print">
          <strong>Notes</strong>
          <div class="note">Use the Purchase List panel on the right to build a shopping/purchase list. You can check items, add notes, save, load or print it.</div>
        </div>
      </main>

      <aside>
        <div class="panel">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
            <h3 style="margin:0;font-size:15px;">Purchase List</h3>
            <div class="right">
              <button id="btnNewPurchase" class="small">New</button>
              <button id="btnSavePurchase" class="small">Save</button>
              <button id="btnLoadPurchase" class="small">Load</button>
              <button id="btnPrintPurchase" class="small">Print</button>
            </div>
          </div>

          <div class="purchase-list" id="purchaseListContainer">
            <!-- purchase items -->
          </div>

          <div style="margin-top:8px;" class="hide-print">
            <button id="btnAddSelected" class="btn">Add Selected Items</button>
            <div class="note" style="margin-top:8px;">Select items in product list using checkboxes (in Actions) then "Add Selected Items".</div>
          </div>
        </div>

        <div class="panel" style="margin-top:12px;">
          <strong>Import/Export</strong>
          <div style="margin-top:8px" class="note">CSV format: barcode,name,category,cost_per_pack,cost_per_pc,sell_per_pc,stocks,notes</div>
          <input id="fileInput" type="file" accept=".csv" style="margin-top:8px" class="hide-print" />
        </div>
      </aside>
    </div>

    <footer>Mattmat’s Inventory — Simple v3.1.1 (Fixed Build) • Offline localStorage first • Drive optional</footer>
  </div>

  <!-- Modals will be injected dynamically -->
  <div id="modals"></div>

<script>
(function(){
  'use strict';

  /* ---------- Configuration placeholders for Drive ---------- */
  const GOOGLE_API_KEY = 'AIzaSyBQ9QgFBIkvxvHMV-3wUr7qXwitxwBp0Ro';
  const GOOGLE_CLIENT_ID = '96651524997-fu2eois3b9geiqdo2js2600hg1mj84p3.apps.googleusercontent.com';

  /* ---------- LocalStorage Keys ---------- */
  const LS_PRODUCTS = 'mattmat_products_v3';
  const LS_CATEGORIES = 'mattmat_categories_v3';
  const LS_PURCHASES = 'mattmat_purchases_v3';

  /* ---------- State ---------- */
  let products = [];
  let categories = [];
  let purchases = {}; // saved purchase lists by name
  let ui = {
    productTable: document.getElementById('productTable'),
    productBody: document.getElementById('productBody'),
    search: document.getElementById('search'),
    filterCategory: document.getElementById('filterCategory'),
    rowsPerPage: document.getElementById('rowsPerPage'),
    fileInput: document.getElementById('fileInput'),
    modals: document.getElementById('modals'),
    purchaseListContainer: document.getElementById('purchaseListContainer')
  };

  /* ---------- Utilities ---------- */
  const uid = (n=8) => Math.random().toString(36).slice(2,2+n);
  const saveProducts = ()=> localStorage.setItem(LS_PRODUCTS, JSON.stringify(products));
  const saveCategories = ()=> localStorage.setItem(LS_CATEGORIES, JSON.stringify(categories));
  const savePurchases = ()=> localStorage.setItem(LS_PURCHASES, JSON.stringify(purchases));

  const loadProducts = ()=>{
    try{
      const raw = localStorage.getItem(LS_PRODUCTS);
      products = raw ? JSON.parse(raw) : sampleProducts();
    }catch(e){ products = sampleProducts(); }
  };
  const loadCategories = ()=>{
    try {
      const raw = localStorage.getItem(LS_CATEGORIES);
      categories = raw ? JSON.parse(raw) : sampleCategories();
    }catch(e){ categories = sampleCategories(); }
  };
  const loadPurchases = ()=>{
    try{
      const raw = localStorage.getItem(LS_PURCHASES);
      purchases = raw ? JSON.parse(raw) : {};
    }catch(e){ purchases = {}; }
  };

  /* ---------- Sample Data (if empty) ---------- */
  function sampleCategories(){
    return [
      { id:'c-general', name:'General' },
      { id:'c-food', name:'Food' },
      { id:'c-house', name:'Household' }
    ];
  }
  function sampleProducts(){
    return [
      { id:uid(6), barcode:'000001', name:'Canned Sardines', category:'Food', cost_pack:120.00, cost_pc:12.00, sell:15.00, stocks:10, notes:'' },
      { id:uid(6), barcode:'000002', name:'Dishwashing Liquid 500ml', category:'Household', cost_pack:150.00, cost_pc:150.00, sell:175.00, stocks:5, notes:'' },
    ];
  }

  /* ---------- Rendering ---------- */
  function refreshCategoryFilter(){
    const sel = ui.filterCategory;
    sel.innerHTML = '<option value="">All categories</option>';
    categories.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.textContent = c.name;
      sel.appendChild(opt);
    });
  }

  let currentSort = { key:'name', dir: 'asc' };
  function renderProducts(){
    const tbody = ui.productBody;
    tbody.innerHTML = '';
    const q = ui.search.value.trim().toLowerCase();
    const catFilter = ui.filterCategory.value;
    const rows = products.filter(p=>{
      if(catFilter && p.category !== catFilter) return false;
      if(!q) return true;
      return (p.name||'').toString().toLowerCase().includes(q) ||
             (p.barcode||'').toString().toLowerCase().includes(q) ||
             (p.notes||'').toString().toLowerCase().includes(q) ||
             (p.category||'').toString().toLowerCase().includes(q);
    });

    rows.sort((a,b)=>{
      const k = currentSort.key;
      let va = a[k], vb = b[k];
      if(typeof va === 'string') va = va.toLowerCase();
      if(typeof vb === 'string') vb = vb.toLowerCase();
      if(va < vb) return currentSort.dir === 'asc' ? -1 : 1;
      if(va > vb) return currentSort.dir === 'asc' ? 1 : -1;
      return 0;
    });

    rows.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(p.barcode || '')}</td>
        <td>${escapeHtml(p.name || '')}</td>
        <td><span class="category-pill">${escapeHtml(p.category || '')}</span></td>
        <td>${Number(p.stocks || 0)}</td>
        <td>₱ ${formatNumber(p.sell)}</td>
        <td class="row-actions">
          <input type="checkbox" data-id="${p.id}" class="select-for-purchase" title="Select for purchase" />
          <button class="small" data-action="edit" data-id="${p.id}">Edit</button>
          <button class="small" data-action="editcost" data-id="${p.id}">Edit Cost</button>
          <button class="small" data-action="delete" data-id="${p.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // bind action handlers
    tbody.querySelectorAll('button[data-action]').forEach(btn=>{
      btn.onclick = (e)=>{
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if(action==='edit') openEditModal(id);
        if(action==='editcost') openEditCostModal(id);
        if(action==='delete') {
          if(confirm('Delete this item?')) {
            products = products.filter(x=>x.id!==id);
            saveProducts();
            renderProducts();
          }
        }
      };
    });
  }

  function renderPurchaseList(){
    const container = ui.purchaseListContainer;
    container.innerHTML = '';
    const saved = purchases['__current'] ? purchases['__current'] : [];
    if(!Array.isArray(saved)) return;
    saved.forEach((it, idx)=>{
      const div = document.createElement('div');
      div.className = 'purchase-item';
      div.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="checkbox" data-idx="${idx}" ${it.checked ? 'checked':''} class="purchase-check" />
          <div>
            <div style="font-weight:600">${escapeHtml(it.name)}</div>
            <div class="note">barcode: ${escapeHtml(it.barcode || '')}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input data-idx="${idx}" class="purchase-qty" type="number" min="1" value="${it.qty||1}" style="width:70px;padding:6px;border:1px solid var(--border);border-radius:6px;" />
          <button class="small" data-action="remove" data-idx="${idx}">Remove</button>
        </div>
      `;
      container.appendChild(div);
    });

    container.querySelectorAll('.purchase-check').forEach(ch=>{
      ch.onchange = (e)=>{
        const idx = +ch.dataset.idx;
        purchases['__current'][idx].checked = ch.checked;
        savePurchases();
      };
    });
    container.querySelectorAll('.purchase-qty').forEach(input=>{
      input.onchange = ()=>{
        const idx = +input.dataset.idx;
        purchases['__current'][idx].qty = Number(input.value) || 1;
        savePurchases();
      };
    });
    container.querySelectorAll('button[data-action="remove"]').forEach(b=>{
      b.onclick = ()=>{
        const idx = +b.dataset.idx;
        purchases['__current'].splice(idx,1);
        savePurchases();
        renderPurchaseList();
      };
    });
  }

  /* ---------- Modals ---------- */
  function openAddModal(){
    openEditModal();
  }

  function openEditModal(id){
    const editing = products.find(p=>p.id===id) || { id: uid(6), barcode:'', name:'', category: categories[0] ? categories[0].name : '', cost_pack:0, cost_pc:0, sell:0, stocks:0, notes:'' };
    const modal = createModal('Add / Edit Item', `
      <div class="form-grid">
        <div class="form-row">
          <label>Barcode</label>
          <input id="m_barcode" type="text" value="${escapeHtml(editing.barcode||'')}" />
        </div>
        <div class="form-row">
          <label>Product Name</label>
          <input id="m_name" type="text" value="${escapeHtml(editing.name||'')}" />
        </div>
        <div class="form-row">
          <label>Category</label>
          <select id="m_category"></select>
        </div>
        <div class="form-row">
          <label>Stocks</label>
          <input id="m_stocks" type="number" min="0" value="${Number(editing.stocks||0)}" />
        </div>
        <div class="form-row">
          <label>Cost / Pack</label>
          <input id="m_cost_pack" type="number" min="0" step="0.01" value="${Number(editing.cost_pack||0)}" />
        </div>
        <div class="form-row">
          <label>Cost / Pc</label>
          <input id="m_cost_pc" type="number" min="0" step="0.01" value="${Number(editing.cost_pc||0)}" />
        </div>
        <div class="form-row">
          <label>Sell / Pc</label>
          <input id="m_sell" type="number" min="0" step="0.01" value="${Number(editing.sell||0)}" />
        </div>
        <div class="form-row" style="grid-column:1/-1">
          <label>Notes</label>
          <textarea id="m_notes" rows="2">${escapeHtml(editing.notes||'')}</textarea>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
        <button id="m_cancel" class="btn">Cancel</button>
        <button id="m_save" class="btn primary">Save</button>
      </div>
    `);

    // populate category select
    const sel = modal.querySelector('#m_category');
    categories.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.textContent = c.name;
      if(c.name === editing.category) opt.selected = true;
      sel.appendChild(opt);
    });

    // smart enter navigation: move to next input
    modal.querySelectorAll('input, textarea, select').forEach((el, idx, arr)=>{
      el.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          const next = arr[idx+1];
          if(next) next.focus();
          else modal.querySelector('#m_save').focus();
        }
      });
    });

    modal.querySelector('#m_cancel').onclick = ()=> closeModal(modal);
    modal.querySelector('#m_save').onclick = ()=>{
      const updated = {
        id: editing.id,
        barcode: modal.querySelector('#m_barcode').value.trim(),
        name: modal.querySelector('#m_name').value.trim(),
        category: modal.querySelector('#m_category').value,
        stocks: Number(modal.querySelector('#m_stocks').value) || 0,
        cost_pack: Number(modal.querySelector('#m_cost_pack').value) || 0,
        cost_pc: Number(modal.querySelector('#m_cost_pc').value) || 0,
        sell: Number(modal.querySelector('#m_sell').value) || 0,
        notes: modal.querySelector('#m_notes').value.trim()
      };
      const idx = products.findIndex(p=>p.id===updated.id);
      if(idx>=0) products[idx] = updated;
      else products.push(updated);
      saveProducts();
      closeModal(modal);
      renderProducts();
    };
  }

  function openEditCostModal(id){
    const p = products.find(x=>x.id===id);
    if(!p) return alert('Product not found.');
    const modal = createModal('Edit Cost', `
      <div class="form-row">
        <label>Cost / Pack</label>
        <input id="mc_cost_pack" type="number" min="0" step="0.01" value="${Number(p.cost_pack||0)}" />
      </div>
      <div class="form-row">
        <label>Cost / Pc</label>
        <input id="mc_cost_pc" type="number" min="0" step="0.01" value="${Number(p.cost_pc||0)}" />
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
        <button id="mc_cancel" class="btn">Cancel</button>
        <button id="mc_save" class="btn primary">Save</button>
      </div>
    `);

    modal.querySelector('#mc_cancel').onclick = ()=> closeModal(modal);
    modal.querySelector('#mc_save').onclick = ()=>{
      p.cost_pack = Number(modal.querySelector('#mc_cost_pack').value) || 0;
      p.cost_pc = Number(modal.querySelector('#mc_cost_pc').value) || 0;
      saveProducts();
      closeModal(modal);
      renderProducts();
    };
  }

  function createModal(title, innerHtml){
    const container = document.createElement('div');
    container.className = 'modal-backdrop';
    container.innerHTML = `
      <div class="modal" role="dialog" aria-modal="true">
        <h3>${escapeHtml(title)}</h3>
        <div>${innerHtml}</div>
      </div>
    `;
    ui.modals.appendChild(container);
    // close on backdrop click
    container.addEventListener('click', (e)=>{
      if(e.target === container){
        closeModal(container);
      }
    });
    return container;
  }
  function closeModal(node){
    if(node && node.parentNode) node.parentNode.removeChild(node);
    // remove all children if many
    // keep minimal for safety
  }

  /* ---------- Import & Export CSV ---------- */
  function exportCSV(){
    const header = ['barcode','name','category','cost_per_pack','cost_per_pc','sell_per_pc','stocks','notes'];
    const lines = [header.join(',')];
    products.forEach(p=>{
      const row = [
        quoteCsv(p.barcode || ''),
        quoteCsv(p.name || ''),
        quoteCsv(p.category || ''),
        Number(p.cost_pack || 0).toFixed(2),
        Number(p.cost_pc || 0).toFixed(2),
        Number(p.sell || 0).toFixed(2),
        Number(p.stocks || 0),
        quoteCsv(p.notes || '')
      ];
      lines.push(row.join(','));
    });
    const csv = lines.join('\n');
    downloadBlob(csv, 'mattmat_products.csv', 'text/csv');
  }

  function importCSVFile(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      const text = reader.result;
      const rows = parseCSV(text);
      const header = rows.shift();
      // map header indexes:
      const idx = {};
      header.forEach((h,i)=> idx[h.trim().toLowerCase()] = i);
      rows.forEach(r=>{
        const p = {
          id: uid(6),
          barcode: r[idx['barcode']] || '',
          name: r[idx['name']] || '',
          category: r[idx['category']] || (categories[0]?categories[0].name:''),
          cost_pack: parseFloat(r[idx['cost_per_pack']]||0) || 0,
          cost_pc: parseFloat(r[idx['cost_per_pc']]||0) || 0,
          sell: parseFloat(r[idx['sell_per_pc']]||0) || 0,
          stocks: parseInt(r[idx['stocks']]||0) || 0,
          notes: r[idx['notes']] || ''
        };
        products.push(p);
      });
      saveProducts();
      renderProducts();
      alert('Import complete. Imported ' + rows.length + ' rows.');
    };
    reader.readAsText(file);
  }

  /* ---------- Drive placeholders (non-breaking) ---------- */
  function driveExport(){
    // Placeholder: logic for Drive export (uses GOOGLE_API_KEY & GOOGLE_CLIENT_ID)
    // Keep code non-executing unless user connects OAuth
    alert('Drive export placeholder. Replace GOOGLE_API_KEY and CLIENT_ID and implement OAuth flow to enable Drive export.');
  }
  function driveImport(){
    alert('Drive import placeholder. Replace GOOGLE_API_KEY and CLIENT_ID and implement OAuth flow to enable Drive import.');
  }

  /* ---------- Purchase list functions ---------- */
  function addSelectedToPurchase(){
    const selected = Array.from(document.querySelectorAll('.select-for-purchase:checked')).map(inp=>{
      const id = inp.dataset.id;
      return products.find(p=>p.id===id);
    }).filter(Boolean);
    if(selected.length === 0) return alert('No items selected.');
    purchases['__current'] = purchases['__current'] || [];
    selected.forEach(s=>{
      purchases['__current'].push({ id:s.id, barcode:s.barcode, name:s.name, qty:1, checked:true });
    });
    savePurchases();
    renderPurchaseList();
  }
  function newPurchase(){
    purchases['__current'] = [];
    savePurchases();
    renderPurchaseList();
  }
  function savePurchaseAs(){
    const name = prompt('Save current purchase list as (enter a name):');
    if(!name) return;
    purchases[name] = JSON.parse(JSON.stringify(purchases['__current'] || []));
    savePurchases();
    alert('Saved purchase list as "'+name+'".');
  }
  function loadPurchase(){
    const keys = Object.keys(purchases).filter(k=> k !== '__current');
    if(keys.length===0) return alert('No saved purchase lists found.');
    const selected = prompt('Saved purchase lists:\n' + keys.join('\n') + '\n\nEnter name to load:');
    if(!selected) return;
    if(!purchases[selected]) return alert('Not found.');
    purchases['__current'] = JSON.parse(JSON.stringify(purchases[selected]));
    savePurchases();
    renderPurchaseList();
  }
  function printPurchase(){
    // open print window with simplified view
    const list = purchases['__current'] || [];
    let html = `<html><head><title>Purchase List</title><style>
      body{font-family:Arial,Helvetica,sans-serif;padding:18px;color:#111}
      h2{margin-top:0}
      .item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #eee}
      .muted{color:#666;font-size:12px}
      </style></head><body><h2>Purchase List</h2><div>`;
    list.forEach(it=>{
      html += `<div class="item"><div><strong>${escapeHtml(it.name)}</strong><div class="muted">barcode: ${escapeHtml(it.barcode||'')}</div></div><div>Qty: ${Number(it.qty||1)}</div></div>`;
    });
    html += `</div></body></html>`;
    const w = window.open('', '_blank');
    w.document.write(html);
    w.document.close();
    w.focus();
    w.print();
  }

  /* ---------- Categories Management (simple modal) ---------- */
  function openCategoriesModal(){
    const modal = createModal('Categories', `
      <div class="form-row">
        <label>Existing Categories</label>
        <div id="catList" style="display:flex;flex-direction:column;gap:6px;max-height:200px;overflow:auto;"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <input id="newCategory" type="text" placeholder="New category name" style="flex:1" />
        <button id="addCat" class="btn">Add</button>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
        <button id="cat_cancel" class="btn">Close</button>
      </div>
    `);
    const list = modal.querySelector('#catList');
    function refresh(){
      list.innerHTML = '';
      categories.forEach((c, idx)=>{
        const d = document.createElement('div');
        d.style.display = 'flex';
        d.style.justifyContent = 'space-between';
        d.style.alignItems = 'center';
        d.innerHTML = `<div>${escapeHtml(c.name)}</div><div style="display:flex;gap:6px;"><button data-idx="${idx}" class="small">Rename</button><button data-idx="${idx}" class="small danger">Delete</button></div>`;
        list.appendChild(d);
      });
      list.querySelectorAll('button').forEach(b=>{
        b.onclick = ()=>{
          const idx = +b.dataset.idx;
          if(b.textContent === 'Delete'){
            if(confirm('Delete category "'+categories[idx].name+'"? This will not delete products but will leave them with the old category text.')) {
              categories.splice(idx,1);
              saveCategories();
              refresh();
              refreshCategoryFilter();
            }
            return;
          }
          if(b.textContent === 'Rename'){
            const newName = prompt('Rename category', categories[idx].name);
            if(newName) {
              const old = categories[idx].name;
              categories[idx].name = newName;
              // update products that matched exactly the old name
              products.forEach(p=>{ if(p.category === old) p.category = newName; });
              saveProducts(); saveCategories();
              refresh(); renderProducts(); refreshCategoryFilter();
            }
          }
        };
      });
    }
    refresh();
    modal.querySelector('#addCat').onclick = ()=>{
      const v = modal.querySelector('#newCategory').value.trim();
      if(!v) return;
      if(categories.some(c=>c.name===v)) return alert('Category exists.');
      categories.push({ id: uid(6), name: v });
      saveCategories();
      modal.querySelector('#newCategory').value = '';
      refresh();
      refreshCategoryFilter();
    };
    modal.querySelector('#cat_cancel').onclick = ()=> closeModal(modal);
  }

  /* ---------- Helpers ---------- */
  function escapeHtml(s){
    if(s === undefined || s === null) return '';
    return String(s).replace(/[&<>"']/g, function(m){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }
  function quoteCsv(s){
    if(s === undefined || s === null) return '""';
    const v = String(s).replace(/"/g,'""');
    return `"${v}"`;
  }
  function parseCSV(text){
    // simple CSV parser - supports quoted fields with commas
    const rows = [];
    const lines = text.split(/\r?\n/);
    for(const line of lines){
      if(!line) continue;
      const row = [];
      let cur = '', inQuotes=false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"' && line[i+1] === '"'){ cur += '"'; i++; continue; }
        if(ch === '"'){ inQuotes = !inQuotes; continue; }
        if(ch === ',' && !inQuotes){ row.push(cur); cur = ''; continue; }
        cur += ch;
      }
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }
  function downloadBlob(text, filename, mime){
    const blob = new Blob([text], { type: mime || 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || 'download.txt';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }
  function formatNumber(n){
    return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  }

  /* ---------- Events ---------- */
  document.getElementById('btnAdd').onclick = openAddModal;
  document.getElementById('btnImport').onclick = ()=> ui.fileInput.click();
  ui.fileInput.onchange = (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    importCSVFile(f);
    ui.fileInput.value = '';
  };
  document.getElementById('btnExport').onclick = exportCSV;
  document.getElementById('btnDriveExport').onclick = driveExport;
  document.getElementById('btnDriveImport').onclick = driveImport;
  document.getElementById('btnCategories').onclick = openCategoriesModal;
  document.getElementById('btnAddSelected').onclick = addSelectedToPurchase;
  document.getElementById('btnNewPurchase').onclick = newPurchase;
  document.getElementById('btnSavePurchase').onclick = savePurchaseAs;
  document.getElementById('btnLoadPurchase').onclick = loadPurchase;
  document.getElementById('btnPrintPurchase').onclick = printPurchase;

  ui.search.oninput = renderProducts;
  ui.filterCategory.onchange = renderProducts;
  ui.rowsPerPage.onchange = renderProducts;

  // sort by clicking headers
  document.querySelectorAll('#productTable thead th[data-key]').forEach(th=>{
    th.onclick = ()=>{
      const key = th.dataset.key;
      if(currentSort.key === key) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
      else { currentSort.key = key; currentSort.dir = 'asc'; }
      // update sort indicators
      document.querySelectorAll('#productTable thead th .sort-ind').forEach(si=> si.textContent = '');
      th.querySelector('.sort-ind').textContent = currentSort.dir === 'asc' ? '▲' : '▼';
      renderProducts();
    };
  });

  // when clicking product selection checkbox, do nothing special here (used by addSelectedToPurchase)
  // keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.key.toLowerCase()==='f'){ e.preventDefault(); ui.search.focus(); }
    if(e.key === 'F1'){ e.preventDefault(); openAddModal(); }
  });

  /* ---------- Init ---------- */
  loadCategories();
  loadProducts();
  loadPurchases();
  refreshCategoryFilter();
  renderProducts();
  renderPurchaseList();

  // expose some functions for console debugging (safe)
  window._mattmat = { products, categories };

  /* ---------- End IIFE ---------- */
})();
</script>

</body>
</html>
