<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Amount × QTY Calculator (Dark)</title>

  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <style>
    * { box-sizing: border-box; }

    html, body {
      -webkit-text-size-adjust: 100%;
      margin: 0;
      background: #000;
      color: #f5f5f7;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow-x: hidden;
    }

    button {
      border: none;
      cursor: pointer;
      font-family: inherit;
      touch-action: manipulation;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 12px 12px 24px; /* reduced bottom padding since keyboard is in-flow */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    h1 {
      text-align: center;
      margin: 8px 0;
      font-size: 20px;
    }

    /* BIG TOTALS */
    .totals {
      display: flex;
      justify-content: space-between;
      background: #111;
      padding: 18px 16px;
      border-radius: 12px;
      font-weight: 700;
      margin-bottom: 0;
      border: 1px solid #2a2a2a;
      box-shadow: 0 2px 6px rgba(0,0,0,0.8);
    }

    .totals span {
      font-size: 26px;
    }

    .label {
      font-size: 14px;
      font-weight: 600;
      color: #a0a0a0;
      display: block;
      margin-bottom: 4px;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .btn-main {
      flex: 1;
      background: #0a84ff;
      color: #fff;
      font-size: 16px;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
    }

    .btn-reset {
      width: 56px;
      background: #111;
      color: #fff;
      font-size: 24px;
      border-radius: 10px;
      border: 1px solid #2a2a2a;
    }

    /* TABLE */
    .table {
      background: #111;
      border-radius: 10px;
      padding: 8px;
      max-height: 50vh;
      overflow-y: auto;
      border: 1px solid #2a2a2a;
    }

    .table-header,
    .item-row {
      display: grid;
      grid-template-columns: 1.3fr 1fr 1fr;
      gap: 6px;
      align-items: center;
    }

    .table-header {
      font-weight: 600;
      color: #b0b0b0;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 4px;
      margin-bottom: 4px;
    }

    .amount-input {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      background: #151515;
      border-radius: 8px;
      border: 1px solid #333;
      text-align: right;
      color: #fff;
    }

    .amount-input::placeholder {
      color: #555;
    }

    .item-row.active .amount-input,
    .item-row.active .qty-input {
      background: #1f1f1f;
      border-color: #0a84ff;
      box-shadow: 0 0 0 2px rgba(10,132,255,0.4);
    }

    .qty-control {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .qty-input {
      width: 48px;
      padding: 6px;
      text-align: center;
      background: #151515;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      font-size: 18px;
    }

    .row-total {
      text-align: right;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }

    /* NUMBER PAD (now in-flow, not floating) */
    .pad {
      position: static; /* changed from fixed */
      margin-top: 8px;
      width: 100%;
      background: #050505;
      padding: 12px;
      border-radius: 12px;
      border-top: 1px solid #181818;
      box-shadow: 0 2px 8px rgba(0,0,0,0.8);
      z-index: 1;
    }

    .pad.hidden {
      display: none;
    }

    .pad-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .num-key {
      padding: 16px 0;
      background: #1c1c1e;
      color: #fff;
      border-radius: 10px;
      font-size: 22px;
      border: 1px solid #2a2a2a;
    }

    .key-secondary { background: #2c2c2e; }
    .key-danger { background: #b00020; }
    .key-main { background: #0a84ff; }

    .num-key[data-key="down"] {
      height: 120px !important;
      font-size: 32px !important;
    }

    /* MODAL (PAYMENT) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }

    .modal {
      background: #111;
      padding: 16px;
      border-radius: 16px;
      width: 92%;
      max-width: 420px;
      border: 1px solid #2a2a2a;
      color: #fff;
      box-shadow: 0 8px 24px rgba(0,0,0,1);
    }

    .modal-title {
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .modal-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .summary-box,
    input.summary-box {
      min-width: 150px;
      padding: 10px;
      border-radius: 10px;
      font-size: 22px;
      font-weight: 700;
      text-align: right;
      background: #1c1c1e;
      color: #fff;
      border: 1px solid #333;
      box-sizing: border-box;
    }

    input.summary-box {
      background: #151515;
    }

    input.summary-box:focus {
      outline: none;
      border-color: #0a84ff;
      box-shadow: 0 0 0 2px rgba(10,132,255,0.4);
    }

    .change-ok { background: #1e8e3e !important; }
    .change-bad { background: #b00020 !important; }

    .modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .btn-done {
      flex: 1;
      background: #1e8e3e;
      color: #fff;
      padding: 12px;
      border-radius: 10px;
      font-weight: 700;
    }

    .btn-cancel {
      flex: 1;
      background: #333;
      color: #fff;
      padding: 12px;
      border-radius: 10px;
      font-weight: 700;
    }

    .cash-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    /* Bigger cash buttons */
    .cash-buttons button {
      padding: 16px 8px;
      border-radius: 12px;
      font-size: 18px;
      background: #1c1c1e;
      color: #fff;
      border: 1px solid #333;
    }

    .cash-buttons button[data-action="manual"] {
      background: #0a84ff;
      grid-column: span 2;
    }

    .cash-buttons button[data-action="clear"] {
      background: #b00020;
    }

    /* RECEIPT MODAL */
    #receiptBackdrop .modal {
      max-height: 90vh;
      overflow-y: auto;
    }

    .receipt-item-row {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 10px;
      background: #151515;
      border: 1px solid #2a2a2a;
    }

    .receipt-item-row label {
      display: block;
      font-size: 13px;
      color: #a0a0a0;
      margin-bottom: 4px;
    }

    .receipt-item-row input {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .receipt-meta {
      font-size: 13px;
      color: #ccc;
    }

    #receiptText {
      width: 100%;
      min-height: 160px;
      margin-top: 10px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #000;
      color: #fff;
      font-family: "Courier New", monospace;
      font-size: 13px;
      white-space: pre;
      resize: vertical;
    }
  </style>
</head>

<body>

<div class="app">
  <h1>Amount × QTY Calculator</h1>

  <div class="totals">
    <div>
      <span class="label">Total Amount</span>
      <span id="totalAmount">0.00</span>
    </div>
    <div style="text-align:right;">
      <span class="label">Total QTY</span>
      <span id="totalQty">0</span>
    </div>
  </div>

  <div class="btn-row">
    <button class="btn-main" id="openSummaryBtn">DONE</button>
    <button class="btn-reset" id="resetBtn">↻</button>
  </div>

  <div class="table">
    <div class="table-header">
      <div>Amount</div>
      <div style="text-align:center;">QTY</div>
      <div style="text-align:right;">Total</div>
    </div>
    <div id="rowsContainer"></div>
  </div>

  <!-- NUMBER PAD (now in-flow at bottom of content) -->
  <div class="pad hidden" id="keypad">
    <!-- Amount keypad -->
    <div class="pad-grid pad-grid-amount">
      <button class="num-key" data-key="7">7</button>
      <button class="num-key" data-key="8">8</button>
      <button class="num-key" data-key="9">9</button>
      <button class="num-key key-secondary" data-key="back">⌫</button>

      <button class="num-key" data-key="4">4</button>
      <button class="num-key" data-key="5">5</button>
      <button class="num-key" data-key="6">6</button>
      <button class="num-key key-danger" data-key="allclear">AC</button>

      <button class="num-key" data-key="1">1</button>
      <button class="num-key" data-key="2">2</button>
      <button class="num-key" data-key="3">3</button>

      <button class="num-key key-main" data-key="down" style="grid-row: span 2;">↓</button>

      <button class="num-key" data-key="0">0</button>
      <button class="num-key" data-key="00">00</button>
      <button class="num-key" data-key=".">.</button>
    </div>

    <!-- QTY keypad: Minus / Plus / Down -->
    <div class="pad-grid pad-grid-qty" style="display:none;">
      <button class="num-key key-danger" data-key="qty-minus">-</button>
      <button class="num-key key-main" data-key="qty-plus">+</button>
      <button class="num-key" data-key="qty-down" style="grid-column: span 2;">↓</button>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-title">Payment Summary</div>

    <div class="modal-row">
      <div>Total Amount:</div>
      <div id="modalTotalAmount" class="summary-box">0.00</div>
    </div>

    <div class="modal-row">
      <div>Cash:</div>
      <input type="number" id="cashInput" class="summary-box" readonly />
    </div>

    <div class="modal-row">
      <div>Change:</div>
      <div id="changeAmount" class="summary-box">0.00</div>
    </div>

    <div class="cash-buttons">
      <button data-cash="5">5</button>
      <button data-cash="10">10</button>
      <button data-cash="20">20</button>
      <button data-cash="50">50</button>

      <button data-cash="100">100</button>
      <button data-cash="500">500</button>
      <button data-cash="1000">1000</button>
      <button data-action="clear">Clear</button>

      <button data-action="manual">Enter Manually</button>
    </div>

    <div class="modal-buttons">
      <button class="btn-done" id="modalDoneBtn">Done</button>
      <button class="btn-cancel" id="modalCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- RECEIPT MODAL -->
<div class="modal-backdrop" id="receiptBackdrop">
  <div class="modal">
    <div class="modal-title">Receipt Items</div>
    <div id="receiptItemsContainer"></div>

    <textarea id="receiptText" readonly></textarea>

    <div class="modal-buttons">
      <button class="btn-done" id="copyReceiptBtn">Copy Receipt</button>
      <button class="btn-cancel" id="receiptCloseBtn">Close & Reset</button>
    </div>
  </div>
</div>

<script>
let activeRowIndex = 0;
let lastPaymentData = null;
let padMode = null;

const rowsContainer  = document.getElementById("rowsContainer");
const totalAmountEl  = document.getElementById("totalAmount");
const totalQtyEl     = document.getElementById("totalQty");
const modal          = document.getElementById("modalBackdrop");
const cashInput      = document.getElementById("cashInput");
const changeAmount   = document.getElementById("changeAmount");
const receiptBackdrop       = document.getElementById("receiptBackdrop");
const receiptItemsContainer = document.getElementById("receiptItemsContainer");
const receiptText           = document.getElementById("receiptText");
const keypad        = document.getElementById("keypad");
const amountPadGrid = document.querySelector(".pad-grid-amount");
const qtyPadGrid    = document.querySelector(".pad-grid-qty");

/* helper: format money with peso sign */
function formatMoney(n){
  if (isNaN(n)) n = 0;
  // Use en-PH locale for comma separators
  return "₱ " + Number(n).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

/* CREATE ROW */
function createRow(index) {
  const row = document.createElement("div");
  row.className = "item-row";
  row.dataset.index = index;

  row.innerHTML = `
    <div>
      <input type="text" class="amount-input" readonly placeholder="0.00">
    </div>
    <div class="qty-control">
      <input type="text" class="qty-input" readonly value="1">
    </div>
    <div class="row-total">0.00</div>
  `;

  const amountInput = row.querySelector(".amount-input");
  const qtyInput    = row.querySelector(".qty-input");

  amountInput.onclick = (e) => {
    e.stopPropagation();
    setActiveRow(index);
    showPad("amount");
  };

  qtyInput.onclick = (e) => {
    e.stopPropagation();
    setActiveRow(index);
    showPad("qty");
  };

  return row;
}

function addRow() {
  const row = createRow(rowsContainer.children.length);
  rowsContainer.appendChild(row);
}

function setActiveRow(index) {
  activeRowIndex = index;
  document.querySelectorAll(".item-row").forEach(r => r.classList.remove("active"));
  const active = document.querySelector(`.item-row[data-index="${index}"]`);
  if (active) active.classList.add("active");
}

function getRow(index) {
  return document.querySelector(`.item-row[data-index="${index}"]`);
}

function getQtyFromRow(row) {
  const qtyInput = row.querySelector(".qty-input");
  return parseInt(qtyInput.value, 10) || 0;
}

function setQtyForRow(row, qty) {
  const qtyInput = row.querySelector(".qty-input");
  qtyInput.value = qty;
}

function updateRowTotal(index) {
  const row = getRow(index);
  if (!row) return;
  const amt = parseFloat(row.querySelector(".amount-input").value) || 0;
  const qty = getQtyFromRow(row);
  row.querySelector(".row-total").textContent = (amt * qty).toFixed(2);
}

function calculateTotals() {
  let totalAmt = 0;
  let totalQty = 0;

  document.querySelectorAll(".item-row").forEach(row => {
    const amt = parseFloat(row.querySelector(".amount-input").value) || 0;
    const qty = getQtyFromRow(row);
    totalAmt += amt * qty;
    totalQty += qty;
  });

  totalAmountEl.textContent = totalAmt.toFixed(2);
  totalQtyEl.textContent    = totalQty;
}

/* SHOW / HIDE KEYPAD */
function showPad(mode) {
  padMode = mode;
  keypad.classList.remove("hidden");
  if (mode === "amount") {
    amountPadGrid.style.display = "grid";
    qtyPadGrid.style.display = "none";
  } else if (mode === "qty") {
    amountPadGrid.style.display = "none";
    qtyPadGrid.style.display = "grid";
  }
}

function hidePad() {
  keypad.classList.add("hidden");
  padMode = null;
}

/* CLICK OUTSIDE TO HIDE KEYPAD */
document.addEventListener("click", function(e) {
  const isAmount = e.target.classList.contains("amount-input");
  const isQty    = e.target.classList.contains("qty-input");
  const inPad    = e.target.closest(".pad") !== null;

  // Amount/QTY clicks are handled by their own onclick (which stopPropagation)
  if (!isAmount && !isQty && !inPad) {
    hidePad();
  }
});

/* NUMBER PAD */
function handlePadInput(key) {
  const row = getRow(activeRowIndex);
  if (!row) return;

  /* QTY mode: use -, +, DOWN from virtual keypad */
  if (key === "qty-minus" || key === "qty-plus" || key === "qty-down") {
    if (key === "qty-down") {
      if (activeRowIndex === rowsContainer.children.length - 1) {
        addRow();
      }
      setActiveRow(activeRowIndex + 1);
      return;
    }

    let qty = getQtyFromRow(row);
    if (key === "qty-minus") {
      qty = Math.max(0, qty - 1);
    } else if (key === "qty-plus") {
      qty = qty + 1;
    }
    setQtyForRow(row, qty);
    updateRowTotal(activeRowIndex);
    calculateTotals();
    return;
  }

  /* Amount mode: numeric keypad */
  const input = row.querySelector(".amount-input");
  let value = input.value || "";

  if (key === "back") {
    value = value.slice(0, -1);
  } else if (key === "allclear") {
    const confirmReset = confirm("This will clear all rows and totals. Continue?");
    if (!confirmReset) return;
    resetAll();
    return;
  } else if (key === "down") {
    if (activeRowIndex === rowsContainer.children.length - 1) {
      addRow();
    }
    setActiveRow(activeRowIndex + 1);
    return;
  } else if (key === ".") {
    if (!value.includes(".")) value += ".";
  } else if (key === "00") {
    if (value !== "") value += "00";
  } else {
    value += key;
  }

  input.value = value;
  updateRowTotal(activeRowIndex);
  calculateTotals();
}

document.querySelectorAll(".num-key").forEach(btn => {
  btn.onclick = (e) => {
    e.stopPropagation();
    handlePadInput(btn.dataset.key);
  };
});

/* PAYMENT SUMMARY */
function setChangeState() {
  const total = parseFloat(totalAmountEl.textContent) || 0;
  const cash  = parseFloat(cashInput.value) || 0;
  const diff  = cash - total;

  changeAmount.textContent = diff.toFixed(2);
  changeAmount.classList.remove("change-ok", "change-bad");

  if (!total && !cash) return;
  if (cash < total) changeAmount.classList.add("change-bad");
  else changeAmount.classList.add("change-ok");
}

document.getElementById("openSummaryBtn").onclick = () => {
  document.getElementById("modalTotalAmount").textContent = totalAmountEl.textContent;
  cashInput.readOnly = true;
  modal.style.display = "flex";
  hidePad();
};

document.getElementById("modalCancelBtn").onclick = () => modal.style.display = "none";

cashInput.oninput = setChangeState;

/* COLLECT SNAPSHOT FOR RECEIPT */
function collectPaymentSnapshot() {
  const items = [];
  document.querySelectorAll(".item-row").forEach(row => {
    const amt = parseFloat(row.querySelector(".amount-input").value) || 0;
    const qty = getQtyFromRow(row);
    const subtotal = amt * qty;
    if (qty > 0 && amt > 0) {
      items.push({ amount: amt, qty, subtotal });
    }
  });

  const total  = parseFloat(totalAmountEl.textContent) || 0;
  const cash   = parseFloat(cashInput.value) || 0;
  const change = parseFloat(changeAmount.textContent) || 0;

  const now    = new Date();
  const dateStr = now.toLocaleDateString();
  const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  return { items, total, cash, change, dateStr, timeStr };
}

/* RECEIPT FORM */
function openReceiptForm(snapshot) {
  lastPaymentData = snapshot;
  receiptItemsContainer.innerHTML = "";
  receiptText.value = "";

  snapshot.items.forEach((item, idx) => {
    const div = document.createElement("div");
    div.className = "receipt-item-row";
    div.innerHTML = `
      <label>Item ${idx + 1}</label>
      <input type="text" class="receipt-name-input" data-index="${idx}" placeholder="Item name">
      <div class="receipt-meta">
        QTY: ${item.qty} &nbsp;&nbsp; Amount: ${formatMoney(item.amount)} &nbsp;&nbsp; Subtotal: ${formatMoney(item.subtotal)}
      </div>
    `;
    receiptItemsContainer.appendChild(div);
  });

  receiptBackdrop.style.display = "flex";
}

function buildReceiptText() {
  if (!lastPaymentData) return "";

  const snap = lastPaymentData;
  const names = [];

  document.querySelectorAll(".receipt-name-input").forEach((input, i) => {
    names[i] = input.value.trim() || `Item ${i + 1}`;
  });

  // Create nicely aligned receipt using monospace padding
  const lines = [];
  lines.push("------------------------------");
  lines.push("Item");
  lines.push("Qty x Amount           Subtotal");
  lines.push("------------------------------");

  snap.items.forEach((item, i) => {
    // Left column: name (max 18 chars)
    const name = (names[i].length > 18) ? names[i].slice(0, 18) : names[i];
    const nameCol = name.padEnd(18, ' ');

    // Middle: qty x amount (e.g. "2 x ₱ 1,000.00") keep short, but we will right align subtotal
    const qtyAmt = item.qty + " x " + formatMoney(item.amount);
    // Subtotal formatted
    const sub = formatMoney(item.subtotal);
    // Build line with name (18 chars) + a space + qtyAmt truncated/padded to 10 + subtotal right aligned 12
    const qtyAmtCol = qtyAmt.length > 10 ? qtyAmt.slice(0,10) : qtyAmt.padEnd(10, ' ');
    const subtotalCol = sub.padStart(12, ' ');
    lines.push(nameCol + " " + qtyAmtCol + subtotalCol);
  });

  lines.push("------------------------------");
  lines.push("TOTAL:" + " ".repeat(20) + formatMoney(snap.total).padStart(12, ' '));
  lines.push("CASH:"  + " ".repeat(21) + formatMoney(snap.cash).padStart(12, ' '));
  lines.push("CHANGE:" + " ".repeat(18) + formatMoney(snap.change).padStart(12, ' '));
  lines.push("------------------------------");

  // add date/time
  lines.push("Date: " + snap.dateStr + "  Time: " + snap.timeStr);

  return lines.join("\n");
}

/* Done button in payment modal */
document.getElementById("modalDoneBtn").onclick = () => {
  const snapshot = collectPaymentSnapshot();
  const wantReceipt = confirm("Payment complete. Do you want to create a receipt?");

  modal.style.display = "none";

  if (wantReceipt && snapshot.items.length > 0) {
    openReceiptForm(snapshot);
  } else {
    resetAll();
  }
};

/* Copy receipt button */
document.getElementById("copyReceiptBtn").onclick = () => {
  const text = buildReceiptText();
  if (!text) {
    alert("No data to generate receipt.");
    return;
  }
  receiptText.value = text;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert("Receipt copied to clipboard.");
    }).catch(() => {
      receiptText.select();
      document.execCommand("copy");
      alert("Receipt copied to clipboard.");
    });
  } else {
    receiptText.select();
    document.execCommand("copy");
    alert("Receipt copied to clipboard.");
  }
};

/* Close receipt + reset */
document.getElementById("receiptCloseBtn").onclick = () => {
  receiptBackdrop.style.display = "none";
  resetAll();
};

/* RESET */
function resetAll() {
  rowsContainer.innerHTML = "";
  addRow();
  setActiveRow(0);
  calculateTotals();
  cashInput.value = "";
  changeAmount.textContent = "0.00";
  changeAmount.classList.remove("change-ok", "change-bad");
  lastPaymentData = null;
  hidePad();
}

/* Top reset with warning */
document.getElementById("resetBtn").onclick = () => {
  const confirmReset = confirm("This will clear all rows and totals. Continue?");
  if (!confirmReset) return;
  resetAll();
};

/* INIT */
resetAll();
</script>

</body>
</html>
