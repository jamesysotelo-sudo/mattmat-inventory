<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Amount × QTY Calculator — Bluetooth Print Integrated</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* (kept same styling as previous file; only trimmed for brevity here) */
    * { box-sizing:border-box }
    html,body{margin:0;background:#000;color:#f5f5f7;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    .app{max-width:480px;margin:0 auto;padding:12px 12px calc(var(--keypad-height,280px)+12px);min-height:100vh}
    h1{text-align:center;font-size:20px;margin:8px 0}
    .totals{display:flex;justify-content:space-between;background:#111;padding:18px;border-radius:12px;margin-bottom:14px;border:1px solid #2a2a2a}
    .label{font-size:14px;color:#a0a0a0}
    .btn-row{display:flex;gap:8px;margin-bottom:10px}
    .btn-main{flex:1;background:#0a84ff;padding:12px;border-radius:10px;font-weight:700;color:#fff}
    .btn-reset{width:56px;background:#111;color:#fff;border-radius:10px}
    .table{background:#111;border-radius:10px;padding:8px;max-height:calc(100vh - 240px);overflow-y:auto;border:1px solid #2a2a2a}
    .table-header,.item-row{display:grid;grid-template-columns:1.3fr 1fr 1fr;gap:6px;align-items:center}
    .amount-input{width:100%;padding:10px;font-size:18px;background:#151515;border-radius:8px;border:1px solid #333;text-align:right;color:#fff}
    .qty-input{width:64px;padding:6px;text-align:center;background:#151515;border-radius:6px;border:1px solid #333;color:#fff}
    .row-total{text-align:right;font-weight:700;color:#fff}
    :root{--keypad-height:280px}
    .pad{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:#050505;padding:12px;border-radius:16px 16px 0 0;border-top:1px solid #181818;box-shadow:0 -4px 12px rgba(0,0,0,.6);z-index:9999;height:var(--keypad-height)}
    .pad-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px}
    .num-key{padding:14px 0;background:#1c1c1e;border-radius:10px;color:#fff;border:1px solid #2a2a2a;font-size:22px;user-select:none}
    .key-secondary{background:#2c2c2e}.key-danger{background:#b00020}.key-main{background:#0a84ff}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:99999}
    .modal{background:#111;padding:16px;border-radius:16px;color:#fff;width:92%;max-width:420px;border:1px solid #2a2a2a}
    .modal-title{text-align:center;font-weight:700;margin-bottom:12px}
    .summary-box{min-width:150px;padding:10px;border-radius:10px;font-weight:700;text-align:right;background:#1c1c1e;color:#fff;border:1px solid #333}
    .receipt-item-row{margin-bottom:10px;padding:8px;border-radius:10px;background:#151515;border:1px solid #2a2a2a}
    .receipt-meta{font-size:13px;color:#ccc}
    .small { font-size:12px; color:#ccc; }
  </style>
</head>
<body>
<div class="app">
  <h1>Amount × QTY Calculator</h1>

  <div class="totals">
    <div>
      <span class="label">Total Amount</span><div id="totalAmount">₱0</div>
    </div>
    <div style="text-align:right">
      <span class="label">Total QTY</span><div id="totalQty">0</div>
    </div>
  </div>

  <div class="btn-row">
    <button class="btn-main" id="openSummaryBtn">DONE</button>
    <button class="btn-reset" id="resetBtn">↻</button>
  </div>

  <div class="table">
    <div class="table-header">
      <div>Amount</div><div style="text-align:center">QTY</div><div style="text-align:right">Total</div>
    </div>
    <div id="rowsContainer"></div>
  </div>
</div>

<!-- keypad (permanent) -->
<div class="pad" id="keypad">
  <div class="pad-grid pad-grid-main">
    <button class="num-key" data-key="7">7</button>
    <button class="num-key" data-key="8">8</button>
    <button class="num-key" data-key="9">9</button>
    <button class="num-key key-secondary" data-key="back">⌫</button>

    <button class="num-key" data-key="4">4</button>
    <button class="num-key" data-key="5">5</button>
    <button class="num-key" data-key="6">6</button>
    <button class="num-key key-danger" data-key="allclear">AC</button>

    <button class="num-key" data-key="1">1</button>
    <button class="num-key" data-key="2">2</button>
    <button class="num-key" data-key="3">3</button>

    <button class="num-key key-main" data-key="down" style="grid-row:span 2">↓</button>

    <button class="num-key" data-key="0">0</button>
    <button class="num-key" data-key="00">00</button>
    <button class="num-key" data-key=".">.</button>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-title">Payment Summary</div>
    <div style="display:flex;justify-content:space-between;margin-bottom:10px">
      <div>Total Amount:</div><div id="modalTotalAmount" class="summary-box">₱0</div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-bottom:10px">
      <div>Cash:</div><input id="cashInput" class="summary-box" readonly />
    </div>
    <div style="display:flex;justify-content:space-between;margin-bottom:10px">
      <div>Change:</div><div id="changeAmount" class="summary-box">₱0</div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px">
      <button data-cash="5">₱5</button><button data-cash="10">₱10</button><button data-cash="20">₱20</button><button data-cash="50">₱50</button>
      <button data-cash="100">₱100</button><button data-cash="500">₱500</button><button data-cash="1000">₱1000</button><button data-action="clear">Clear</button>
      <button style="grid-column:span 2" data-action="manual">Enter Manually</button>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn-main" id="modalDoneBtn">Done</button>
      <button class="btn-reset" id="modalCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- RECEIPT MODAL -->
<div class="modal-backdrop" id="receiptBackdrop">
  <div class="modal">
    <div class="modal-title">Receipt Items</div>
    <div id="receiptItemsContainer"></div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn-main" id="printReceiptBtn">Print Receipt (Browser)</button>
      <button class="btn-main" id="bluetoothPrintBtn">Print to Bluetooth Printer</button>
      <button class="btn-reset" id="receiptCloseBtn">Close & Reset</button>
    </div>
    <div class="small" style="margin-top:8px">Tip: Bluetooth Print app must be installed and "Browser Print" enabled. If the app cannot be opened, host a response URL and use server-based printing (see instructions below).</div>
  </div>
</div>

<script>
/* ---------- core calculator logic (kept from your working file) ---------- */
/* For brevity this code keeps the behavior you already approved: amounts whole numbers, keypad always visible, qty numeric allowed, rows scrolling above keypad. */

/* Utility and state */
const rowsContainer = document.getElementById('rowsContainer');
const totalAmountEl = document.getElementById('totalAmount');
const totalQtyEl = document.getElementById('totalQty');
const modal = document.getElementById('modalBackdrop');
const receiptBackdrop = document.getElementById('receiptBackdrop');
const receiptItemsContainer = document.getElementById('receiptItemsContainer');
const modalTotalAmount = document.getElementById('modalTotalAmount');
const cashInput = document.getElementById('cashInput');
const changeAmount = document.getElementById('changeAmount');

let activeRowIndex = 0;
let padMode = 'amount';
let lastPaymentData = null;

/* formatting whole pesos */
function formatMoneyWhole(num){
  if(isNaN(num)) num = 0;
  return new Intl.NumberFormat('en-PH',{style:'currency',currency:'PHP',maximumFractionDigits:0}).format(Math.round(num));
}

/* Create rows, keep same behavior as before */
function createRow(index){
  const r = document.createElement('div');
  r.className = 'item-row';
  r.dataset.index = index;
  r.innerHTML = `<div><input type="text" class="amount-input" readonly placeholder="₱0" data-raw=""></div>
                 <div class="qty-control"><input type="text" class="qty-input" readonly value="1"></div>
                 <div class="row-total">₱0</div>`;
  const ai = r.querySelector('.amount-input');
  const qi = r.querySelector('.qty-input');
  ai.onclick = (e)=>{ e.stopPropagation(); setActiveRow(index); setPadMode('amount'); };
  qi.onclick = (e)=>{ e.stopPropagation(); setActiveRow(index); setPadMode('qty'); };
  return r;
}
function addRow(){ rowsContainer.appendChild(createRow(rowsContainer.children.length)); }
function getRow(i){ return document.querySelector('.item-row[data-index="'+i+'"]'); }
function setActiveRow(i){
  if(i<0)i=0;
  if(i>=rowsContainer.children.length) i = rowsContainer.children.length-1;
  activeRowIndex = i;
  document.querySelectorAll('.item-row').forEach(x=>x.classList.remove('active'));
  const a = getRow(i); if(a){ a.classList.add('active'); a.scrollIntoView({block:'nearest',behavior:'smooth'}); }
}
function getQtyFromRow(row){ return parseInt(row.querySelector('.qty-input').value,10)||0; }
function setQtyForRow(row,q){ q = Math.max(0,Math.floor(q||0)); row.querySelector('.qty-input').value = q; }
function updateRowTotal(i){
  const row = getRow(i); if(!row) return;
  const raw = row.querySelector('.amount-input').dataset.raw || '';
  const amt = parseInt(raw.replace(/^0+/,'' )||'0',10)||0;
  const qty = getQtyFromRow(row);
  row.querySelector('.row-total').textContent = formatMoneyWhole(amt*qty);
}
function calculateTotals(){
  let ta=0,tq=0;
  document.querySelectorAll('.item-row').forEach(row=>{
    const raw = row.querySelector('.amount-input').dataset.raw || '';
    const amt = parseInt(raw.replace(/^0+/,'')||'0',10)||0;
    const qty = getQtyFromRow(row);
    ta += amt*qty; tq += qty;
  });
  totalAmountEl.textContent = formatMoneyWhole(ta);
  totalQtyEl.textContent = tq;
}

/* keypad handling */
const numKeys = Array.from(document.querySelectorAll('.num-key'));
function setPadMode(m){
  padMode = (m==='qty') ? 'qty' : 'amount';
  const btnDot = document.querySelector('.num-key[data-key="."]');
  const btn00 = document.querySelector('.num-key[data-key="00"]');
  if(padMode==='qty'){ if(btnDot) btnDot.textContent='−'; if(btn00) btn00.textContent='+'; }
  else { if(btnDot) btnDot.textContent='.'; if(btn00) btn00.textContent='00'; }
}
function handlePadInput(key){
  const row = getRow(activeRowIndex);
  if(!row) return;
  if(padMode==='qty'){
    if(key==='.'){ key='qty-decr'; }
    if(key==='00'){ key='qty-incr'; }
  }
  // qty behavior
  if(padMode==='qty' && (key==='qty-decr' || key==='qty-incr' || /^[0-9]$/.test(key))){
    const qi = row.querySelector('.qty-input');
    let qty = getQtyFromRow(row);
    if(key==='qty-decr') qty = Math.max(0,qty-1);
    else if(key==='qty-incr') qty = qty+1;
    else { // numeric append
      const digit = key;
      const cur = String(qi.value||"");
      let newVal = (cur==='0'?digit:(cur+digit));
      newVal = newVal.replace(/^0+/,'')||"0"; newVal = newVal.slice(0,6);
      qty = parseInt(newVal,10)||0;
    }
    setQtyForRow(row,qty); updateRowTotal(activeRowIndex); calculateTotals(); return;
  }
  // amount behavior (whole numbers)
  if(padMode==='amount'){
    const ai = row.querySelector('.amount-input');
    let raw = ai.dataset.raw || '';
    if(key==='back'){ raw = raw.slice(0,-1); }
    else if(key==='allclear'){ if(!confirm('This will clear all rows and totals. Continue?')) return; resetAll(); return; }
    else if(key==='down'){ if(activeRowIndex===rowsContainer.children.length-1) addRow(); setActiveRow(activeRowIndex+1); setPadMode('amount'); return; }
    else if(key==='00'){ if(raw!=='') raw = raw + '00'; }
    else if(/^[0-9]$/.test(key)){ raw = (raw + key).replace(/^0+/, '') || '0'; raw = raw.slice(0,9); }
    ai.dataset.raw = raw;
    const numeric = parseInt(raw||'0',10)||0;
    ai.value = raw==='' ? '' : formatMoneyWhole(numeric);
    updateRowTotal(activeRowIndex); calculateTotals(); return;
  }
}
// attach
numKeys.forEach(btn=>btn.onclick = (e)=>{ e.stopPropagation(); handlePadInput(btn.dataset.key); });

/* initial rows */
function resetAll(){
  rowsContainer.innerHTML='';
  addRow(); setActiveRow(0); calculateTotals();
  cashInput.value=''; changeAmount.textContent = formatMoneyWhole(0); changeAmount.classList.remove('change-ok','change-bad');
  lastPaymentData = null; setPadMode('amount');
}
document.getElementById('resetBtn').onclick = ()=>{ if(!confirm('This will clear all rows and totals. Continue?')) return; resetAll(); };

resetAll();

/* ---------- Payment/Receipt logic ---------- */
function collectPaymentSnapshot(){
  const items=[];
  document.querySelectorAll('.item-row').forEach(row=>{
    const raw = row.querySelector('.amount-input').dataset.raw||'';
    const amt = parseInt((raw.replace(/^0+/,'')||'0'),10)||0;
    const qty = getQtyFromRow(row);
    const subtotal = amt * qty;
    if(qty>0 && amt>0) items.push({amount:amt, qty:qty, subtotal:subtotal});
  });
  const total = parseInt((totalAmountEl.textContent||'').replace(/[^0-9]/g,'')||'0',10)||0;
  const cash = Math.round(parseFloat(cashInput.value||'0')||0);
  const change = Math.round(parseFloat(changeAmount.textContent.replace(/[^0-9-]/g,'')||'0')||0);
  const now = new Date();
  return {items, total, cash, change, dateStr: now.toLocaleDateString(), timeStr: now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})};
}

function openReceiptForm(snapshot){
  lastPaymentData = snapshot;
  receiptItemsContainer.innerHTML = '';
  snapshot.items.forEach((it, idx)=>{
    const div = document.createElement('div');
    div.className = 'receipt-item-row';
    div.innerHTML = `<label>Item ${idx+1}</label>
      <input class="receipt-name-input" data-index="${idx}" placeholder="Item name" />
      <div class="receipt-meta">QTY: ${it.qty} &nbsp; Amount: ${formatMoneyWhole(it.amount)} &nbsp; Subtotal: ${formatMoneyWhole(it.subtotal)}</div>`;
    receiptItemsContainer.appendChild(div);
  });
  receiptBackdrop.style.display = 'flex';
}

/* modal open */
document.getElementById('openSummaryBtn').onclick = ()=>{
  modalTotalAmount.textContent = totalAmountEl.textContent;
  cashInput.readOnly = true;
  modal.style.display = 'flex';
  setPadMode('amount');
};
document.getElementById('modalCancelBtn').onclick = ()=>modal.style.display='none';
document.getElementById('modalDoneBtn').onclick = ()=>{
  const snapshot = collectPaymentSnapshot();
  const wantReceipt = confirm('Payment complete. Do you want to create a receipt?');
  modal.style.display = 'none';
  if(wantReceipt && snapshot.items.length>0) openReceiptForm(snapshot);
  else resetAll();
};

/* cash buttons behavior */
Array.from(document.querySelectorAll('.modal .modal button[data-cash], .modal button[data-action]')).forEach(b=>{
  b.onclick = ()=>{
    const add = parseFloat(b.dataset.cash||'0');
    const action = b.dataset.action || '';
    if(add){ let c = parseFloat(cashInput.value||'0'); c += add; cashInput.value = c.toFixed(0); setChangeState(); }
    else if(action==='clear'){ cashInput.value=''; changeAmount.textContent = formatMoneyWhole(0); changeAmount.classList.remove('change-ok','change-bad'); }
    else if(action==='manual'){ cashInput.readOnly=false; cashInput.focus(); cashInput.select && cashInput.select(); }
  };
});
function setChangeState(){
  const total = parseInt((totalAmountEl.textContent||'').replace(/[^0-9]/g,'')||'0',10)||0;
  const cash = Math.round(parseFloat(cashInput.value||'0')||0);
  const diff = cash - total;
  changeAmount.textContent = formatMoneyWhole(diff);
  changeAmount.classList.remove('change-ok','change-bad');
  if(!total && !cash) return;
  if(cash < total) changeAmount.classList.add('change-bad'); else changeAmount.classList.add('change-ok');
}
cashInput.oninput = setChangeState;

/* ---------- Printing ---------- */

/* 1) Browser print (existing) */
document.getElementById('printReceiptBtn').onclick = ()=>{
  // build printable HTML like before
  if(!lastPaymentData) return alert('No receipt data.');
  const html = buildPrintableReceiptHTML();
  const w = window.open('','_blank','width=400,height=600');
  w.document.open();
  w.document.write(html);
  w.document.close();
  setTimeout(()=>{ w.focus(); w.print(); },300);
};

/* helper to build printable HTML */
function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function buildPrintableReceiptHTML(){
  const snap = lastPaymentData; if(!snap) return '';
  const names = Array.from(document.querySelectorAll('.receipt-name-input')).map((i,idx)=> (i.value || `Item ${idx+1}`));
  let rowsHtml='';
  snap.items.forEach((it,i)=>{
    const name = document.querySelectorAll('.receipt-name-input')[i].value || `Item ${i+1}`;
    rowsHtml += `<tr><td style="padding:4px 0;font-family:monospace;font-size:13px">${escapeHtml(name)}</td><td style="padding:4px 0;text-align:right;font-family:monospace;font-size:13px">${formatMoneyWhole(it.subtotal)}</td></tr>`;
    rowsHtml += `<tr><td style="padding:0 0 6px 0;font-family:monospace;font-size:12px;color:#444">${it.qty} x ${formatMoneyWhole(it.amount)}</td><td></td></tr>`;
  });
  const nowLine = `<div style="font-family:monospace;font-size:12px;color:#333">Date: ${snap.dateStr} &nbsp; Time: ${snap.timeStr}</div>`;
  return `<!doctype html><html><head><meta charset="utf-8"/><title>Receipt</title><style>body{margin:10px;font-family:Arial;} .receipt{width:300px} h2{text-align:center}</style></head><body><div class="receipt"><h2>MATTMAT SARI-SARI STORE</h2><div style="text-align:center">Brgy. ________, City ________</div>${nowLine}<table style="width:100%;border-collapse:collapse">${rowsHtml}</table><table style="width:100%;margin-top:6px;border-top:1px dashed #000"><tr><td>TOTAL:</td><td style="text-align:right;font-weight:700">${formatMoneyWhole(snap.total)}</td></tr><tr><td>CASH:</td><td style="text-align:right;font-weight:700">${formatMoneyWhole(snap.cash)}</td></tr><tr><td>CHANGE:</td><td style="text-align:right;font-weight:700">${formatMoneyWhole(snap.change)}</td></tr></table><div style="text-align:center;margin-top:10px">Thank you for purchasing!</div></div></body></html>`;
}

/* 2) Bluetooth printing integration */
document.getElementById('bluetoothPrintBtn').onclick = bluetoothPrint;

/* Build JSON payload in the Bluetooth Print App format (see your uploaded note). */
function buildBluetoothPayload(){
  if(!lastPaymentData) return null;
  const snap = lastPaymentData;
  // names from inputs
  const names = Array.from(document.querySelectorAll('.receipt-name-input')).map((el, i)=> el.value.trim() || `Item ${i+1}`);
  const payload = [];
  // Title - bold center
  payload.push({ type:0, content: 'MATTMAT SARI-SARI STORE', bold:1, align:1, format:0 });
  payload.push({ type:0, content: 'Brgy. ________, City ________', bold:0, align:1, format:0 });
  payload.push({ type:0, content: `Date: ${snap.dateStr}    Time: ${snap.timeStr}`, bold:0, align:0, format:0 });
  payload.push({ type:0, content: '---', bold:0, align:0, format:0 });

  snap.items.forEach((it,i)=>{
    // item name (text)
    payload.push({ type:0, content: names[i], bold:0, align:0, format:0 });
    // qty x price and subtotal on next lines
    payload.push({ type:0, content: `${it.qty} x ₱${numberWithCommas(it.amount)}\t₱${numberWithCommas(it.subtotal)}`, bold:0, align:0, format:0 });
  });

  payload.push({ type:0, content: '---', bold:0, align:0, format:0 });
  payload.push({ type:0, content: `TOTAL:\t₱${numberWithCommas(snap.total)}`, bold:1, align:2, format:0 });
  payload.push({ type:0, content: `CASH:\t₱${numberWithCommas(snap.cash)}`, bold:0, align:2, format:0 });
  payload.push({ type:0, content: `CHANGE:\t₱${numberWithCommas(snap.change)}`, bold:0, align:2, format:0 });
  payload.push({ type:0, content: 'Thank you for purchasing!', bold:0, align:1, format:0 });

  return payload;
}

function numberWithCommas(x){
  if(x==null) x=0;
  return String(x).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

/* Try to open the Bluetooth Print app using bprint://<responseURL>
   We'll attempt to use a data: URL with the JSON payload embedded (so you don't need a server).
   NOTE: some browsers / app combinations reject data: URLs. If that happens, use the server-based approach below. */
function bluetoothPrint(){
  if(!lastPaymentData) return alert('No receipt data to print.');
  const payload = buildBluetoothPayload();
  if(!payload) return alert('No payload');

  try {
    const json = JSON.stringify(payload);
    // Build a data: URL
    const responseDataUrl = 'data:application/json;charset=utf-8,' + encodeURIComponent(json);
    const bprintUrl = 'bprint://' + encodeURIComponent(responseDataUrl);

    // Try to open bluetooth print app by navigating to bprint://...
    // Opening as location.href works in many cases; using window.open as fallback
    const opened = window.open(bprintUrl, '_self');
    // If popup blocked or app not handling the scheme, advise user
    setTimeout(() => {
      // In many mobile browsers there is no reliable callback; show guidance
      if (!opened) {
        const proceed = confirm('Bluetooth Print app did not open. This can happen due to browser restrictions. Do you want instructions to host a response.php on a webserver for reliable printing?');
        if (proceed) {
          showServerInstructions();
        }
      }
    }, 600);
  } catch (err) {
    alert('Bluetooth print failed: ' + (err.message || err));
  }
}

/* Show instructions for server-based response (reliable) */
function showServerInstructions(){
  const msg = "Reliable printing: host a response URL on a webserver (e.g., response.php) that returns the JSON payload.\n\nI can generate a sample response.php that prints this receipt format. Would you like that?";
  if(confirm(msg)) {
    // build the JSON and show it in a new tab (so you can copy/paste to your server)
    const payload = buildBluetoothPayload();
    const w = window.open();
    w.document.write('<pre>' + escapeHtml(JSON.stringify(payload, null, 2)) + '</pre><hr/>');
    w.document.write('<p>Sample server response (PHP) to place at <code>response.php</code> on your server:</p>');
    w.document.write('<pre>' + escapeHtml(sampleResponsePhp()) + '</pre>');
    w.document.close();
  }
}
function sampleResponsePhp(){
  // Use the example from your uploaded instructions (adapted)
  return `<?php
header('Content-Type: application/json');
// Build array of objects similar to the payload
$a = array();
$obj1 = new stdClass(); $obj1->type = 0; $obj1->content = 'MATTMAT SARI-SARI STORE'; $obj1->bold = 1; $obj1->align = 1; $obj1->format = 0; array_push($a,$obj1);
$obj2 = new stdClass(); $obj2->type = 0; $obj2->content = 'Brgy. ________, City ________'; $obj2->bold = 0; $obj2->align = 1; $obj2->format = 0; array_push($a,$obj2);
// Add items...
echo json_encode($a);
?>`;
}

/* helper: build lastPaymentData when user clicks Done in modal.
   We already collected snapshot on Done earlier, but ensure lastPaymentData exists */
document.getElementById('receiptCloseBtn').onclick = ()=>{
  receiptBackdrop.style.display = 'none';
  resetAll();
};

/* ensure receipt print flow uses current names before calling Bluetooth print */
document.getElementById('bluetoothPrintBtn').onclick = ()=>{
  // Read and save names into lastPaymentData if present
  if(!lastPaymentData){ alert('No receipt data'); return; }
  // copy names into lastPaymentData.items
  const nameInputs = document.querySelectorAll('.receipt-name-input');
  nameInputs.forEach((inp, i)=> { lastPaymentData.items[i].name = inp.value.trim() || (`Item ${i+1}`); });
  bluetoothPrint();
};

</script>
</body>
</html>
