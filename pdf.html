<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mattmat Purchase Text (Copy)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f5f5f5;
      color: #111;
    }

    body {
      margin: 0;
      padding: 12px;
      background: #f5f5f5;
    }

    .wrap {
      max-width: 640px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      padding: 12px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 18px;
      margin: 0 0 4px 0;
      text-align: center;
    }

    .note {
      font-size: 12px;
      color: #555;
      text-align: center;
      margin-bottom: 10px;
    }

    .buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #fafafa;
      cursor: pointer;
      font-size: 14px;
    }

    button:active {
      transform: scale(0.98);
    }

    #copyBtn {
      background: #4caf50;
      border-color: #388e3c;
      color: #fff;
      font-weight: 600;
    }

    #refreshBtn {
      background: #eeeeee;
    }

    #status {
      font-size: 12px;
      text-align: center;
      margin-bottom: 8px;
      min-height: 16px;
      color: #333;
    }

    textarea {
      width: 100%;
      min-height: 260px;
      box-sizing: border-box;
      resize: vertical;
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 8px;
      font-family: "Courier New", Courier, monospace;
      font-size: 13px;
      white-space: pre;
    }

    @media (max-width: 600px) {
      .wrap {
        border-radius: 0;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mattmat Purchase â€” Text Copy</h1>
    <div class="note">
      Uses items marked for purchase in your main inventory (checked items).<br>
      Format: <code>***CATEGORY***</code> then <code>- Item</code>
    </div>

    <div class="buttons">
      <button id="refreshBtn">ðŸ”„ Refresh from Inventory</button>
      <button id="copyBtn">ðŸ“‹ Copy Text</button>
    </div>

    <div id="status"></div>

    <textarea id="output" readonly placeholder="No data yet..."></textarea>
  </div>

  <script>
    // Must match your main app key:
    // from your index.html: const KEY = 'store_inventory_v3_2_7';
    const KEY = 'store_inventory_v3_2_7';

    const outputEl = document.getElementById('output');
    const statusEl = document.getElementById('status');
    const copyBtn = document.getElementById('copyBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    function loadProductsFromLocalStorage() {
      try {
        const raw = localStorage.getItem(KEY);
        if (!raw) return [];
        const data = JSON.parse(raw);
        if (!Array.isArray(data)) return [];
        return data;
      } catch (e) {
        console.error('Error reading products from localStorage', e);
        return [];
      }
    }

    function escapePlain(str) {
      return String(str ?? "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    }

    function buildText() {
      const products = loadProductsFromLocalStorage();

      if (!products || products.length === 0) {
        statusEl.textContent = 'No products found in localStorage.';
        outputEl.value = '';
        return;
      }

      // Only items that are checked (selected for purchase)
      const checked = products.filter(p => p && p.checked);
      if (checked.length === 0) {
        statusEl.textContent = 'No items are checked for purchase.';
        outputEl.value = '';
        return;
      }

      // Group by category, keep insertion order
      const groups = new Map();
      checked.forEach(item => {
        const cat = (item.category && item.category.toString().trim())
          ? item.category.toString().trim()
          : 'UNCATEGORIZED';
        const name = (item.name || '').toString().trim();
        if (!name) return;

        if (!groups.has(cat)) {
          groups.set(cat, []);
        }
        groups.get(cat).push(name);
      });

      // Build text:
      // ***CATEGORY***
      // - Item
      let lines = [];
      for (const [cat, items] of groups.entries()) {
        lines.push('***' + escapePlain(cat).toUpperCase() + '***');
        items.forEach(name => {
          lines.push('- ' + escapePlain(name));
        });
        lines.push(''); // blank line between categories
      }

      const result = lines.join('\n');
      outputEl.value = result;
      statusEl.textContent = 'Loaded ' + checked.length + ' item(s) in ' + groups.size + ' categor(y/ies).';
    }

    async function copyText() {
      const text = outputEl.value || '';
      if (!text.trim()) {
        statusEl.textContent = 'Nothing to copy.';
        return;
      }

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          // fallback
          outputEl.focus();
          outputEl.select();
          document.execCommand('copy');
        }
        statusEl.textContent = 'Copied to clipboard âœ…';
      } catch (e) {
        console.error('Copy failed', e);
        statusEl.textContent = 'Copy failed. You can select and copy manually.';
      }
    }

    copyBtn.addEventListener('click', copyText);
    refreshBtn.addEventListener('click', buildText);

    // Auto-load on first open
    window.addEventListener('load', buildText);
  </script>
</body>
</html>
